# coding: utf-8
# email: qfsfdxlqy@163.com
# Github: https://github.com/2015qyliang

##########################################################################

library(igraph)
library(brainGraph)

library(tidyverse)
library(NetSwan)
library(ggplot2)
library(ggsci)

##########################################################################

getMinE = function(fn){
  nodes = read.table(paste0('./NetInfo/', fn,' node_attribute.txt'), 
                     header = T, sep = '\t', stringsAsFactors = F)
  nodes$No..module = paste0('M_', nodes$No..module)
  rownames(nodes) = nodes$id
  links = read.table(paste0('./NetInfo/', fn,' edge_attribute.txt'),
                     header = T, sep = '\t', stringsAsFactors = F)
  net.graph = graph_from_data_frame( d = links, vertices = nodes, directed = F)
  
  e.global = efficiency(net.graph, type = 'global')
  
  e.nodes = c()
  for (nd in nodes$id) {
    nodes.nd = nodes[nodes$id != nd, ]
    links.nd = links[(links$from != nd) & (links$to != nd) , ]
    net.graph.nd = graph_from_data_frame( d = links.nd, vertices = nodes.nd, directed = F)
    e.nd = efficiency(net.graph.nd, type = 'global')
    e.nodes = append(e.nodes, e.nd)
  }
  
  return(c(e.global, round(max((e.global-e.nodes)/e.global), digits = 4)))
}

##########################################################################

sampleGroups = read.table('02-RMTvalue.txt', header = T, sep = '\t', stringsAsFactors = F)
vulnerability = c()
efficient = c()
for (i in 1:length(sampleGroups$groups)) {
  fn = paste0(sampleGroups$groups[i], ' ', sprintf('%0.2f', sampleGroups$value[i]))
  efficient = append(efficient, getMinE(fn)[1])
  vulnerability = append(vulnerability, getMinE(fn)[2]) 
}

vulDF = data.frame(Group = sampleGroups$groups, efficient, vulnerability)

write.table(vulDF, '06-EffiVulnDF.txt', append = F, sep = '\t', row.names = F, col.names = T)

